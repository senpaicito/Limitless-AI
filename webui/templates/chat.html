{% extends "base.html" %}

{% block content %}
<div class="chat-container">
    <div class="chat-sidebar">
        <div class="sidebar-section">
            <h3>üß† Memory Stats</h3>
            <div id="memory-stats">
                <div class="stat-item">
                    <span class="stat-label">Total Memories:</span>
                    <span class="stat-value" id="total-memories">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Vector DB:</span>
                    <span class="stat-value" id="vector-db-status">Loading...</span>
                </div>
            </div>
        </div>
        
        <div class="sidebar-section">
            <h3>üòä Emotional State</h3>
            <div id="emotional-state">
                <div class="emotion-display">
                    <span class="emotion-label">Primary:</span>
                    <span class="emotion-value" id="primary-emotion">neutral</span>
                </div>
                <div class="emotion-intensity">
                    <div class="intensity-bar">
                        <div class="intensity-fill" id="intensity-fill" style="width: 50%;"></div>
                    </div>
                    <span class="intensity-text" id="intensity-text">50%</span>
                </div>
            </div>
        </div>
        
        <div class="sidebar-section">
            <h3>üîç Semantic Search</h3>
            <div class="search-box">
                <input type="text" id="memory-search" placeholder="Search memories...">
                <button id="search-btn" class="btn-secondary">Search</button>
            </div>
            <div id="search-results" class="search-results"></div>
        </div>
    </div>
    
    <div class="chat-main">
        <div class="chat-header">
            <h2>Chat with {{ character_name }}</h2>
            <div class="chat-actions">
                <button id="clear-chat" class="btn-secondary">Clear Chat</button>
                <button id="export-chat" class="btn-secondary">Export</button>
            </div>
        </div>
        
        <div class="chat-messages" id="chat-messages">
            <!-- Messages will be loaded here -->
        </div>
        
        <div class="chat-input-container">
            <div class="input-group">
                <textarea id="message-input" placeholder="Type your message here..." rows="3"></textarea>
                <button id="send-button" class="btn-primary">Send</button>
            </div>
            <div class="input-options">
                <label>
                    <input type="checkbox" id="use-semantic-search" checked>
                    Use Semantic Search
                </label>
                <label>
                    <input type="checkbox" id="emotional-context" checked>
                    Emotional Context
                </label>
            </div>
        </div>
    </div>
</div>

<script>
    // Chat functionality
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const chatMessages = document.getElementById('chat-messages');
    const clearChatBtn = document.getElementById('clear-chat');
    
    function addMessage(sender, message, emotion = 'neutral', timestamp = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;
        
        const time = timestamp || new Date().toLocaleTimeString();
        
        messageDiv.innerHTML = `
            <div class="message-header">
                <span class="message-sender">${sender === 'user' ? 'You' : '{{ character_name }}'}</span>
                <span class="message-time">${time}</span>
            </div>
            <div class="message-content">${message}</div>
            ${sender === 'ai' ? `<div class="message-emotion">Feeling: ${emotion}</div>` : ''}
        `;
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;
        
        // Add user message to chat
        addMessage('user', message);
        messageInput.value = '';
        
        // Send to server
        socket.emit('send_message', { message: message });
    }
    
    // Event listeners
    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    clearChatBtn.addEventListener('click', function() {
        chatMessages.innerHTML = '';
    });
    
    // Socket event handlers
    socket.on('ai_response', function(data) {
        addMessage('ai', data.message, data.emotion);
        
        // Update emotional state display
        document.getElementById('primary-emotion').textContent = data.emotion;
        document.getElementById('intensity-fill').style.width = (data.intensity * 100) + '%';
        document.getElementById('intensity-text').textContent = Math.round(data.intensity * 100) + '%';
    });
    
    // Load chat history
    fetch('/api/chat/history')
        .then(response => response.json())
        .then(conversations => {
            conversations.forEach(conv => {
                addMessage('user', conv.user, '', new Date(conv.timestamp).toLocaleTimeString());
                addMessage('ai', conv.ai, conv.emotion, new Date(conv.timestamp).toLocaleTimeString());
            });
        });
    
    // Load memory stats
    fetch('/api/memory/stats')
        .then(response => response.json())
        .then(stats => {
            document.getElementById('total-memories').textContent = stats.total_memories || 0;
            document.getElementById('vector-db-status').textContent = 
                stats.vector_memory_enabled ? 'Enabled' : 'Disabled';
        });
    
    // Memory search
    document.getElementById('search-btn').addEventListener('click', function() {
        const query = document.getElementById('memory-search').value;
        if (!query) return;
        
        // This would call a search API endpoint
        console.log('Searching for:', query);
    });
</script>
{% endblock %}